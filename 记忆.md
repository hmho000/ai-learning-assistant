# AI 学习助手项目记忆文档

## 项目概述
这是一个 React + Vite + TypeScript 前端项目，用于 AI 学习助手的题库系统。

## 最近的操作记录

### 2024年 - 答题模式功能实现

#### 功能描述
在题库页面新增了"答题模式"，允许用户一次性完成所有题目并提交，与原有的"练习模式"（每道题独立作答）区分开来。

#### 实现内容

1. **类型定义扩展** (`frontend/src/types/quiz.ts`)
   - 新增 `UserAnswer` 接口：用于存储用户答案
   - 新增 `QuizResult` 接口：用于存储答题结果
   - 新增 `ScoreResult` 接口：用于存储得分详情

2. **工具函数扩展** (`frontend/src/utils/quizUtils.ts`)
   - `loadQuizJsonByChapter(chapterId: number)`: 根据章节号加载 JSON 题库文件
   - `calcScore(quiz: QuizData, answers: UserAnswer[])`: 计算答题得分，返回得分、总分和每道题的详情

3. **存储功能扩展** (`frontend/src/utils/quizStorage.ts`)
   - `saveQuizResult(result)`: 保存答题结果到 localStorage，同时更新统计信息
   - 支持传入 `detail` 参数，用于更新每道题的详细统计信息（正确/错误次数等）

4. **答题模式组件** (`frontend/src/components/quiz/`)
   - `QuizExamView.tsx`: 答题模式主组件，管理所有答案状态，支持一次性提交
   - `MultipleChoiceQuestionExam.tsx`: 答题模式的选择题组件，支持 value/onChange 模式
   - `FillInBlankQuestionExam.tsx`: 答题模式的填空题组件，支持 value/onChange 模式
   - `QuizExamSummary.tsx`: 答题结果总结组件，显示得分、正确率、错题列表等

5. **页面功能扩展** (`frontend/src/pages/QuestionsPage.jsx`)
   - 新增"阅读题库"和"开始答题"两个模式切换按钮
   - 添加 `viewMode`、`quizData`、`quizLoading`、`quizError` 状态管理
   - 章节切换时自动重置模式和题库数据
   - 根据模式切换显示不同的组件（QuestionViewer 或 QuizExamView）

#### 设计原则
- **解耦合**: 答题模式组件与练习模式组件分离，各自独立维护
- **类型安全**: 使用 TypeScript 确保类型一致性
- **可维护性**: 代码结构清晰，功能模块化

#### 文件结构
```
frontend/src/
├── types/
│   └── quiz.ts                    # 类型定义（已扩展）
├── utils/
│   ├── quizUtils.ts               # 工具函数（已扩展）
│   └── quizStorage.ts             # 存储功能（已扩展）
├── components/
│   ├── quiz/
│   │   ├── QuizView.tsx           # 练习模式组件（原有）
│   │   ├── QuizExamView.tsx       # 答题模式组件（新增）
│   │   ├── MultipleChoiceQuestion.tsx      # 练习模式选择题（原有）
│   │   ├── MultipleChoiceQuestionExam.tsx  # 答题模式选择题（新增）
│   │   ├── FillInBlankQuestion.tsx         # 练习模式填空题（原有）
│   │   ├── FillInBlankQuestionExam.tsx     # 答题模式填空题（新增）
│   │   ├── QuizSummary.tsx        # 练习模式总结（原有）
│   │   └── QuizExamSummary.tsx    # 答题模式总结（新增）
│   └── QuestionViewer.jsx         # Markdown 阅读器（原有）
└── pages/
    └── QuestionsPage.jsx          # 题库页面（已扩展）
```

#### 使用说明
1. 用户在题库页面可以选择"阅读题库"或"开始答题"模式
2. 选择"开始答题"后，系统会加载对应章节的 JSON 题库文件
3. 用户可以填写所有题目，然后点击"提交答案"一次性提交
4. 提交后会显示得分、正确率和详细的答题结果
5. 答题结果会自动保存到 localStorage

#### 文档更新记录（2025年）
- ✅ 更新 README.md：将"答题交互功能"从"规划中"改为"已完成"，并添加详细功能说明
- ✅ 更新"项目功能与命令说明书.md"：
  - 添加答题模式功能说明
  - 更新前端组件结构说明
  - 添加 JSON 文件复制说明
  - 补充答题模式使用流程和数据存储说明
  - 更新文件路径速查表

#### 注意事项
- 答题模式使用 `QuizExamView` 组件，练习模式使用 `QuizView` 组件
- 两种模式的题目组件 props 接口不同，需要分别维护
- JSON 题库文件路径格式：`/questions/ch{chapterId}_questions.json`
- 题目 ID 格式：选择题为 `mc-{id}`，填空题为 `fb-{id}`

### 2025年11月 - 引入 FastAPI 后端与打包方案

#### 功能描述
在现有 React + Vite 前端基础上，新增 FastAPI 后端，统一托管打包后的前端静态文件，并通过 PyInstaller 将整个应用打包为单文件可执行程序（exe），方便在 Windows 下分发使用。

#### 实现内容
1. **后端依赖管理**（`requirements.txt`）  
   - 新增后端依赖：`fastapi`、`uvicorn`、`pyinstaller`（后续若有需要可追加其他库）。

2. **FastAPI 后端应用**（`backend/app.py`）  
   - 创建 `FastAPI` 实例 `app`，项目标题为“AI 学习助手 Backend”。  
   - 约定前端构建输出目录为 `frontend/dist`，通过 `FRONTEND_DIST_DIR` 计算绝对路径。  
   - 如果 `frontend/dist` 不存在，只打印警告，不让应用崩溃。  
   - 使用 `StaticFiles` 挂载 `/assets` 静态目录，对应 `frontend/dist/assets`。  
   - `GET /`：返回打包后的 `index.html`，如果文件不存在，返回纯文本提示“请先在 frontend 目录执行 npm run build”。  
   - `GET /{full_path:path}`：作为 SPA 路由兜底，将所有非 `/api/` 开头路径都指向前端 `index.html`（支持 React Router）；`/api/*` 留给真正 API 处理。  
   - 示例接口：`GET /api/health` 返回 `{status: "ok"}`；`GET /api/sample-quiz` 返回一份示例题目 JSON，用于前后端联调。

3. **启动脚本**（项目根目录 `run_app.py`）  
   - 使用当前 Python 解释器通过 `uvicorn` 启动 `backend.app:app`，监听 `127.0.0.1:8000`。  
   - 启动子进程后等待约 2 秒，再用默认浏览器打开 `http://127.0.0.1:8000`。  
   - 进程主线程阻塞等待后端子进程退出，支持 `Ctrl+C` 中断时优雅终止子进程。  
   - 此脚本将作为 PyInstaller 打包入口（`pyinstaller -F run_app.py`）。

4. **打包脚本**（项目根目录 `build_exe.sh` / `build_exe.bat`）  
   - 统一打包流程：安装后端依赖 → 构建前端 → 调用 PyInstaller 打包。  
   - `build_exe.sh`（Linux/Mac）：
     - `pip install -r requirements.txt`  
     - 进入 `frontend` 执行 `npm install && npm run build`  
     - 回到项目根目录执行 `pyinstaller -F run_app.py`  
     - 打印提示：可执行文件位于 `dist/run_app` 或 `dist/run_app.exe`。  
   - `build_exe.bat`（Windows）：
     - 步骤与 `build_exe.sh` 等价，使用 `pip`、`npm` 与 `pyinstaller`，最终生成 `dist\run_app.exe`。  

5. **Vite 配置调整**（`frontend/vite.config.js`）  
   - 明确 `build.outDir` 为默认的 `"dist"`，与 FastAPI 静态托管目录保持一致。  
   - 在 `server.proxy` 中新增 `/api` 代理，将开发环境下的 `/api/*` 请求转发到 `http://localhost:8000`，简化本地联调。  
   - 保留原有 `port: 5173` 设置，前端开发入口仍为 `http://localhost:5173`。

#### 设计与解耦原则
- **前后端解耦，部署统一**：开发阶段前端仍可通过 `npm run dev` 独立运行，请求通过 Vite 代理转发到 FastAPI；发布阶段由 FastAPI 托管打包后的静态文件，并通过单个 exe 启动整体应用。  
- **路径约定清晰**：约定前端构建产物在 `frontend/dist`，后端只依赖该目录，不直接耦合前端源码结构。  
- **打包流程简单、一键化**：通过 `build_exe.sh` / `build_exe.bat` 脚本，把依赖安装、前端构建和后端打包串联成一条流水线，减少手工操作。  
- **方便后续扩展**：后端示例接口仅占用 `/api/health` 和 `/api/sample-quiz`，后续可以按模块化方式继续扩展 `/api/*` 路由而不影响静态托管逻辑。
-
### 2025年11月 - Windows 打包脚本健壮性增强

#### 变更背景
- 用户在 Windows 11 下直接双击 `build_exe.bat` 时，遇到“无法正常构建 exe”问题，需要提升脚本在图形界面双击场景下的鲁棒性和提示信息。

#### 具体修改（`build_exe.bat`）
- **工作目录固定**：在脚本开头增加 `cd /d "%~dp0"`，确保无论从什么位置双击运行，当前工作目录都会切换到项目根目录，避免相对路径错误导致构建失败。  
- **编码设置**：添加 `chcp 65001 >nul`，统一使用 UTF-8 控制台编码，使中文日志在 Windows 控制台下显示正常。  
- **环境检查**：在正式执行前增加：
  - `where py`：检查 Python 启动器是否存在，不存在时给出安装 Python 与 PATH 配置的指引。  
  - `where npm`：检查 Node.js/npm 是否存在，不存在时提示安装 Node.js。  
- **统一使用 `py -m` 风格命令**：
  - 将 `pip install -r requirements.txt` 改为 `py -m pip install -r requirements.txt`，尽量避免多 Python 版本下的 `pip` 混用问题。  
  - 将 `python -m PyInstaller -F run_app.py` 改为 `py -m PyInstaller -F run_app.py`，与 Windows 上推荐的 Python 启动方式一致。  
- **自动安装 PyInstaller**：
  - 在打包前通过 `py -m pip show pyinstaller` 检查是否已安装 PyInstaller，未安装时自动执行 `py -m pip install pyinstaller`。  
- **前端构建步骤增强提示**：
  - 保持 `npm install` 与 `npm run build` 的执行逻辑不变，但对失败场景增加更明确的中文错误说明（例如建议先单独运行 `npm run dev` 确认工程是否正常）。  
- **日志与步骤标号**：
  - 为四个主要阶段增加 `[1/4] ~ [4/4]` 的阶段性提示，用户在双击运行时能够清晰看到当前卡在哪一步。  
  - 在脚本结尾输出统一的成功信息，明确 `dist\run_app.exe` 的位置和使用方式。  
  - 在所有可能调用 `.cmd`/`.bat` 的命令（如 `npm install`、`npm run build`、`py -m pip ...`、`py -m PyInstaller ...`）前增加 `call` 前缀，确保当前批处理在调用这些脚本后能够正确返回继续执行后续步骤。  

#### 终止提示优化
- 在脚本尾部增加：  
  - `echo [完成] 打包流程结束。`  
  - `pause`  
- 这样在资源管理器中双击运行时，用户可以清楚看到打包流程已经完成，不会因为窗口立即关闭而错过关键信息。  

#### 目的与效果
- 减少因"从错误目录运行脚本"、"未安装 Python/Node"、"未安装 PyInstaller"等环境问题导致的构建失败，并用清晰的中文输出引导用户自查环境。  
- 保持前后端打包流程不变，仅增强健壮性和可维护性，符合项目的"解耦合、可维护性强"的设计原则。

### 2025年11月 - 修复打包后 exe 无法启动服务的问题

#### 问题描述
- 用户成功构建 `run_app.exe` 后，双击运行时会无限打开浏览器显示 `ERR_CONNECTION_REFUSED` 错误页面。
- 原因分析：`run_app.py` 使用 `subprocess.Popen` 调用 `sys.executable -m uvicorn`，但在 PyInstaller 打包的单文件 exe 中，这种方式无法正常工作，因为打包后的 exe 不能作为 Python 解释器运行 `-m` 模块。

#### 修复内容

1. **重构 `run_app.py`**：
   - 移除 `subprocess` 方式，改为直接导入并运行 `uvicorn.run()`，这样在打包后的 exe 中也能正常工作。
   - 改进路径处理：使用 `sys.frozen` 检测是否为打包模式，正确获取 exe 所在目录作为工作目录。
   - 添加错误处理：检查 `uvicorn` 模块是否存在，启动失败时给出明确的错误提示和可能原因。
   - 改进浏览器打开逻辑：使用后台线程延迟打开浏览器，避免阻塞主线程。
   - 增加启动日志：显示工作目录、服务地址等信息，方便调试。

2. **更新 `run_app.spec`**：
   - 在 `hiddenimports` 中添加 `backend`、`backend.app` 以及 uvicorn 相关的所有子模块，确保 PyInstaller 能正确打包这些依赖：
     - `uvicorn` 及其所有关键子模块（`uvicorn.lifespan`、`uvicorn.protocols`、`uvicorn.loops` 等）
   - 这样可以避免打包后运行时出现模块导入错误。

3. **更新 `build_exe.bat`**：
   - 将 `call py -m PyInstaller -F run_app.py` 改为 `call py -m PyInstaller run_app.spec`，确保使用包含完整配置的 spec 文件进行打包。

#### 技术要点
- **直接运行 vs 子进程**：在 PyInstaller 打包的 exe 中，直接调用 `uvicorn.run()` 比通过 `subprocess` 调用更可靠。
- **隐藏导入配置**：PyInstaller 可能无法自动检测到某些动态导入的模块（如 uvicorn 的内部模块），需要在 spec 文件中显式声明。
- **路径处理**：打包后的 exe 运行时，`__file__` 指向临时解压目录，需要使用 `sys.executable` 和 `sys.frozen` 来正确获取 exe 所在目录。

#### 效果
- exe 文件现在可以正常启动后端服务，浏览器能成功访问 `http://127.0.0.1:8000`。
- 如果启动失败，会显示清晰的错误信息，帮助用户快速定位问题。

### 2025年11月 - 修复打包后前端无法加载题库数据的问题

#### 问题描述
- 打包后的 exe 运行后，浏览器能打开页面，但显示"当前暂无可用课程"，无法加载题库数据。
- 原因分析：前端代码通过 `fetch("/questions/manifest.json")` 请求题库清单文件，但后端 `app.py` 只挂载了 `/assets` 静态目录，没有挂载 `/questions` 目录，导致请求返回 404。

#### 修复内容
- **更新 `backend/app.py`**：
  - 在静态文件挂载部分，新增对 `/questions` 目录的挂载：
    ```python
    # 挂载 questions 目录（包含 manifest.json 和题库文件）
    questions_dir = os.path.join(FRONTEND_DIST_DIR, "questions")
    if os.path.isdir(questions_dir):
        app.mount("/questions", StaticFiles(directory=questions_dir), name="questions")
    ```
  - 这样前端就能正常访问 `/questions/manifest.json` 和 `/questions/ch*.json`、`/questions/ch*.md` 等题库文件了。

#### 技术要点
- **静态资源挂载顺序**：FastAPI 的 `app.mount()` 需要在使用通配路由（如 `/{full_path:path}`）之前挂载，否则会被通配路由拦截。
- **路径一致性**：确保 `FRONTEND_DIST_DIR` 指向的目录下同时包含 `assets` 和 `questions` 两个子目录。

#### 效果
- 打包后的 exe 现在可以正常加载并显示题库数据。
- 前端能够成功请求 `/questions/manifest.json` 获取课程清单，并加载对应的题库文件。

### 2025年11月 - 修复打包时文件被占用的问题

#### 问题描述
- 重新打包时出现 `PermissionError: [WinError 5] 拒绝访问` 错误，无法覆盖 `dist\run_app.exe`。
- 原因分析：旧的 `run_app.exe` 文件正在运行或被其他程序（如杀毒软件、文件管理器）占用，PyInstaller 无法删除并覆盖它。

#### 修复内容
- **更新 `build_exe.bat`**：
  - 在打包前（第 [3/4] 步）增加检查逻辑：
    - 如果 `dist\run_app.exe` 存在，先尝试删除它
    - 如果删除失败（文件被占用），提示用户关闭正在运行的 exe 进程或相关程序，然后退出
    - 如果删除成功，继续打包流程
  - 增强错误提示：在 PyInstaller 打包失败时，列出可能的原因（文件被占用、权限不足等），帮助用户快速定位问题。

#### 技术要点
- **文件删除命令**：使用 `del /F /Q dist\run_app.exe`，`/F` 强制删除只读文件，`/Q` 静默模式不提示确认。
- **错误检测**：通过检查文件是否仍然存在来判断删除是否成功。
- **用户体验**：提供清晰的错误提示，指导用户如何解决问题。

#### 效果
- 打包脚本现在会自动处理旧的 exe 文件，避免文件占用导致的打包失败。
- 如果文件确实被占用，会给出明确的提示，用户只需关闭相关程序后重新运行脚本即可。

### 2026年1月8日 - 错题本题号显示逻辑修复

#### 问题
错题本显示的题号是全局ID（跨越多章），应该是每章内的相对题号1-5。

#### 修复
1. **后端** (`backend/app.py`): 计算每题在其quiz内同类型的相对位置，添加`question_number`字段；按题型+相对题号排序
2. **前端** (`frontend/src/pages/MistakeBookPage.jsx`): 显示`question_number`而不是`id`

#### 结果
- 单选题、填空题各显示为 1-5（而非全局11-15、16-20）
- 与生成题库的相对题号完全对应